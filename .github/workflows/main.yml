name: Deploy with Vault AppRole

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Vault CLI
        run: |
          curl -fsSL https://releases.hashicorp.com/vault/1.15.5/vault_1.15.5_linux_amd64.zip -o vault.zip
          unzip vault.zip
          sudo mv vault /usr/local/bin/

      - name: Login to Vault using AppRole
        id: vault-login
        run: |
          TOKEN=$(curl -s \
            --request POST \
            --data '{"role_id":"${{ secrets.VAULT_ROLE_ID }}","secret_id":"${{ secrets.VAULT_SECRET_ID }}"}' \
            ${{ secrets.VAULT_ADDR }}/v1/auth/approle/login \
            | jq -r .auth.client_token)

          echo "VAULT_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "VAULT_ADDR=${{ secrets.VAULT_ADDR }}" >> $GITHUB_ENV

      - name: Render YAML from Vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: |
          export APP_URL=$(vault kv get -field=APP_URL secret/app/development/database_config)
          export API_ENDPOINT=$(vault kv get -field=API_ENDPOINT secret/app/development/database_config)
          envsubst < .env.tpl > .env
          cp .env app.yaml
          cat app.yaml
          chmod 600 app.yaml